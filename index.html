<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Compare Weeks - Customizable</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h2, h3 { margin-top: 20px; }
  #dropZone {
    border: 3px dashed #888;
    padding: 30px;
    text-align: center;
    color: #666;
    margin-bottom: 20px;
    transition: background 0.3s ease;
  }
  #dropZone.dragover { background: #e0f7fa; border-color: #00796b; color: #00796b; }
  #metricSelector h4 { margin-top: 10px; }
  .metric-option { display: block; margin-bottom: 5px; }
  .tables-container { display: flex; justify-content: space-between; gap: 20px; margin-top: 20px; }
  table { border-collapse: collapse; width: 100%; font-size: 14px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  th { background: #f4f4f4; }
  .summary { background: #eef; padding: 10px; border-radius: 5px; margin-top: 20px; }
  .green { background: #d4edda; }
  .red { background: #f8d7da; }
  #chartsContainer { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px; }
  canvas { background: #fff; padding: 10px; border-radius: 6px; }
  #globalLegend { text-align: center; margin-top: 15px; font-weight: bold; }
  #globalLegend span { margin: 0 10px; }
</style>
</head>
<body>

<h2>Upload CSV to Compare Weeks</h2>
<div id="dropZone">
  <p>Drag & Drop CSV file here OR click to browse</p>
  <input type="file" id="csvFile" accept=".csv" style="display:none;" />
</div>

<div id="metricSelector"></div>
<button id="generateBtn" style="display:none;">Generate Report</button>

<div class="tables-container">
  <div id="week1Table"></div>
  <div id="week2Table"></div>
</div>
<div id="summary" class="summary"></div>
<div id="chartsContainer"></div>
<div id="globalLegend"></div>

<div id="saveSection" style="margin-top:20px;">
  <button id="saveBtn" style="padding:10px 15px; display:none;">Save as PDF</button>
  <p id="saveMsg" style="color: green; font-weight: bold; margin: 0;"></p>
</div>

<script>
let allMetrics = [];
let groups = [
    { label: "25 ft Walk", metrics: [2, 3] },
    { label: "6 min Walk", metrics: [5] },
    { label: "GaitRite Normal", metrics: [7, 8, 9] },
    { label: "GaitRite Fast", metrics: [10, 11, 12] },
    { label: "Plantarflexion", metrics: [13, 14] },
    { label: "Dorsiflexion", metrics: [15, 16] },
    { label: "MS Walk Scale", metrics: [17] }
];
let week1 = [], week2 = [];

// Drag & Drop
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('csvFile');
dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
    e.preventDefault(); dropZone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.includes("csv")) parseCSV(file);
});
fileInput.addEventListener('change', e => parseCSV(e.target.files[0]));

function parseCSV(file) {
    Papa.parse(file, {
        complete: function(results) {
            const data = results.data.slice(1);
            const headers = results.data[0];
            week1 = data.slice(0, 3);
            week2 = data.slice(3, 6);
            allMetrics = headers.map((h, i) => ({ name: h, col: i }));

            // Build metric selector grouped by assessments
            const selectorDiv = document.getElementById('metricSelector');
            selectorDiv.innerHTML = "<h3>Select Metrics</h3>";
            groups.forEach(g => {
                selectorDiv.innerHTML += `<h4>${g.label}</h4>`;
                g.metrics.forEach(colIdx => {
                    selectorDiv.innerHTML += `<label class="metric-option"><input type="checkbox" value="${colIdx}" checked> ${allMetrics[colIdx].name}</label>`;
                });
            });
            document.getElementById('generateBtn').style.display = "inline-block";
        }
    });
}

document.getElementById('generateBtn').addEventListener('click', () => {
    const selectedCols = Array.from(document.querySelectorAll('#metricSelector input:checked')).map(cb => parseInt(cb.value));
    generateTables(selectedCols);
    generateCharts(selectedCols);
    generateSummary(selectedCols);
    createGlobalLegend();
    document.getElementById('saveBtn').style.display = "inline-block";
});

function generateTables(selectedCols) {
    document.getElementById('week1Table').innerHTML = "<h3>Week 1</h3>" + createTable(selectedCols, week1);
    document.getElementById('week2Table').innerHTML = "<h3>Week 2</h3>" + createTable(selectedCols, week2);
}

function createTable(selectedCols, rows) {
    let html = "<table><tr><th>Metric</th><th>Pre</th><th>Post</th><th>Follow-up</th><th>% Change</th></tr>";
    selectedCols.forEach(col => {
        const pre = parseFloat(rows[0][col]) || NaN;
        const post = parseFloat(rows[1][col]) || NaN;
        const follow = parseFloat(rows[2][col]) || NaN;
        const pctChange = (!isNaN(pre) && !isNaN(post) && pre !== 0) ? (((post - pre) / pre) * 100).toFixed(2) + "%" : "-";
        const colorClass = parseFloat(pctChange) > 0 ? 'class="green"' : (parseFloat(pctChange) < 0 ? 'class="red"' : '');
        html += `<tr><td>${allMetrics[col].name}</td><td>${isNaN(pre) ? '-' : pre.toFixed(2)}</td><td>${isNaN(post) ? '-' : post.toFixed(2)}</td><td>${isNaN(follow) ? '-' : follow.toFixed(2)}</td><td ${colorClass}>${pctChange}</td></tr>`;
    });
    html += "</table>";
    return html;
}

function generateCharts(selectedCols) {
    const chartsContainer = document.getElementById('chartsContainer');
    chartsContainer.innerHTML = "";
    selectedCols.forEach(col => {
        const canvas = document.createElement('canvas');
        chartsContainer.appendChild(canvas);
        const labels = ['Wk1-Pre', 'Wk1-Post', 'Wk2-Pre', 'Wk2-Post'];
        const data = [
            parseFloat(week1[0][col]) || 0,
            parseFloat(week1[1][col]) || 0,
            parseFloat(week2[0][col]) || 0,
            parseFloat(week2[1][col]) || 0
        ];
        new Chart(canvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: ['#ff99ff','#cc00cc','#66ccff','#0099ff']
                }]
            },
            options: {
                responsive: true,
                plugins: { title: { display: true, text: allMetrics[col].name }, legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    });
}

function createGlobalLegend() {
    document.getElementById('globalLegend').innerHTML = `
        <span style="color:#ff99ff;">■ Wk1-Pre</span>
        <span style="color:#cc00cc;">■ Wk1-Post</span>
        <span style="color:#66ccff;">■ Wk2-Pre</span>
        <span style="color:#0099ff;">■ Wk2-Post</span>
    `;
}

function generateSummary(selectedCols) {
    let summaries = [];
    selectedCols.forEach(col => {
        const w1avg = avg([parseFloat(week1[0][col]), parseFloat(week1[1][col])]);
        const w2avg = avg([parseFloat(week2[0][col]), parseFloat(week2[1][col])]);
        if (!isNaN(w1avg) && !isNaN(w2avg)) {
            let diffPercent = ((w2avg - w1avg) / w1avg * 100).toFixed(2);
            summaries.push(`${allMetrics[col].name}: ${w2avg > w1avg ? 'Week 2 higher' : 'Week 1 higher'} (${w1avg.toFixed(2)} vs ${w2avg.toFixed(2)}) (${diffPercent}%)`);
        }
    });
    document.getElementById('summary').innerHTML = "<h3>Summary</h3><ul><li>" + summaries.join("</li><li>") + "</li></ul>";
}

function avg(arr) {
    const valid = arr.filter(x => !isNaN(x));
    return valid.length ? valid.reduce((a,b) => a+b,0)/valid.length : NaN;
}
</script>
</body>
</html>
