<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Custom Week Comparison</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
h2 { margin-bottom: 10px; }
#dropZone {
    border: 2px dashed #999;
    padding: 20px;
    text-align: center;
    background: #fff;
    margin-bottom: 20px;
    cursor: pointer;
}
.button-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}
.button-bar button {
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}
#generateBtn { background: #28a745; color: white; }
#saveConfigBtn, #loadConfigBtn { background: #6c757d; color: white; }
#exportPDFBtn { background: #007bff; color: white; display:none; }
select { padding: 6px; }
#configSection {
    background: #fff;
    padding: 15px;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin-bottom: 20px;
}
.flex-container { display: flex; gap: 20px; }
.panel {
    flex: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background: #fafafa;
}
.metric-list { list-style: none; padding: 0; min-height: 50px; }
.metrics-item {
    background: #fff;
    border: 1px solid #ccc;
    padding: 6px;
    margin-bottom: 5px;
    cursor: grab;
}
.group {
    border: 1px solid #ccc;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 6px;
    background: #fff;
}
.group-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}
.delete-group {
    background: #ff4d4d;
    color: white;
    border: none;
    padding: 3px 8px;
    cursor: pointer;
    border-radius: 4px;
}
.drag-over { background: #e6f7ff; }
#outputSection {
    background: white;
    padding: 20px;
    border-radius: 8px;
}
.tables-container {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    justify-content: flex-start;
}
table {
    border-collapse: collapse;
    width: 100%;
    max-width: 500px;
    font-size: 14px;
    margin-bottom: 20px;
}
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #f4f4f4; }
#chartsContainer {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 20px;
    justify-content: flex-start;
}
.chart-block {
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 6px;
    background: #fff;
    width: 370px;
    cursor: grab;
}
#chartsContainer canvas {
    width: 350px !important;
    height: 250px !important;
}
.legend {
    text-align: center;
    margin-top: 15px;
    display: none;
}
.legend span { margin: 0 10px; }
</style>
</head>
<body>

<h2>Upload CSV File</h2>
<div id="dropZone">Drag & Drop CSV Here or Click to Upload</div>
<input type="file" id="csvFile" accept=".csv" style="display:none;" />

<div class="button-bar">
    <button id="generateBtn">Generate Comparison</button>
    <button id="saveConfigBtn">Save Configuration</button>
    <select id="configSelect">
        <option value="">Select Configuration</option>
    </select>
    <button id="loadConfigBtn">Load Configuration</button>
    <button id="exportPDFBtn">Save as PDF</button>
</div>

<div id="configSection">
    <div id="configContent">
        <div class="flex-container">
            <div class="panel">
                <h3>Available Metrics</h3>
                <ul id="unassigned" class="metric-list"></ul>
            </div>
            <div class="panel" id="groupsPanel">
                <h3>Groups</h3>
                <button id="addGroupBtn" style="margin-bottom:10px;">+ Add Group</button>
            </div>
        </div>
    </div>
</div>

<div id="outputSection">
    <div id="output"></div>
    <div id="chartsContainer"></div>
    <div class="legend" id="legend">
        <span style="color:#ff6384;">■ Week 1 Pre</span>
        <span style="color:#ff3864;">■ Week 1 Post</span>
        <span style="color:#36a2eb;">■ Week 2 Pre</span>
        <span style="color:#3677eb;">■ Week 2 Post</span>
    </div>
</div>

<script>
let rawData = [], headers = [];

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('csvFile');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.background="#eef"; });
dropZone.addEventListener('dragleave', () => dropZone.style.background="#fff");
dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.style.background="#fff";
    handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

function handleFile(file) {
    Papa.parse(file, {
        header: true,
        complete: function(results) {
            headers = results.meta.fields;
            rawData = results.data.filter(r => r[headers[0]]);
            populateMetrics();
        }
    });
}

function populateMetrics() {
    const ul = document.getElementById('unassigned');
    ul.innerHTML = '';
    headers.slice(1).forEach((h, i) => {
        const li = createMetricItem(h, i);
        ul.appendChild(li);
    });
    enableDragDrop();
}

function createMetricItem(name, id) {
    const li = document.createElement('li');
    li.textContent = name;
    li.className = 'metrics-item';
    li.setAttribute('draggable', 'true');
    li.dataset.id = id;
    li.addEventListener('dblclick', () => {
        const newName = prompt('Rename metric:', li.textContent);
        if (newName) li.textContent = newName;
    });
    return li;
}

document.getElementById('addGroupBtn').addEventListener('click', () => {
    const name = prompt('Enter group name:');
    if (!name) return;
    const groupDiv = document.createElement('div');
    groupDiv.className = 'group';
    groupDiv.innerHTML = `
        <div class="group-header">
            <span class="group-name">${name}</span>
            <button class="delete-group">✖</button>
        </div>
        <ul class="metric-list"></ul>
    `;
    groupDiv.querySelector('.delete-group').addEventListener('click', () => {
        const metricsToReturn = groupDiv.querySelectorAll('.metrics-item');
        metricsToReturn.forEach(item => document.getElementById('unassigned').appendChild(item));
        groupDiv.remove();
    });
    groupDiv.querySelector('.group-name').addEventListener('dblclick', () => {
        const newName = prompt('Rename group:', name);
        if (newName) groupDiv.querySelector('.group-name').textContent = newName;
    });
    document.getElementById('groupsPanel').insertBefore(groupDiv, document.getElementById('addGroupBtn'));
    enableDragDrop();
});

function enableDragDrop() {
    document.querySelectorAll('.metrics-item').forEach(item => {
        item.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', item.dataset.id));
    });
    document.querySelectorAll('.metric-list').forEach(list => {
        list.addEventListener('dragover', e => { e.preventDefault(); list.classList.add('drag-over'); });
        list.addEventListener('dragleave', () => list.classList.remove('drag-over'));
        list.addEventListener('drop', e => {
            e.preventDefault();
            const id = e.dataTransfer.getData('text/plain');
            const dragged = document.querySelector(`.metrics-item[data-id="${id}"]`);
            if (dragged) list.appendChild(dragged);
            list.classList.remove('drag-over');
        });
    });
}

document.getElementById('generateBtn').addEventListener('click', () => {
    const groups = [];
    document.querySelectorAll('#groupsPanel .group').forEach(g => {
        const name = g.querySelector('.group-name').textContent;
        const metrics = Array.from(g.querySelectorAll('.metrics-item')).map(li => li.textContent);
        if (metrics.length > 0) groups.push({ name, metrics });
    });
    if (groups.length > 0) {
        document.getElementById('legend').style.display = 'block';
        document.getElementById('exportPDFBtn').style.display = 'inline-block';
    }
    document.getElementById('configSection').style.display = 'none'; // Auto-hide config
    buildTablesCharts(groups);
});

function buildTablesCharts(groups) {
    const outputDiv = document.getElementById('output');
    const chartsContainer = document.getElementById('chartsContainer');
    outputDiv.innerHTML = '';
    chartsContainer.innerHTML = '';

    groups.forEach(group => {
        const tableHTML = `
            <h3>${group.name}</h3>
            <table>
                <tr><th>Metric</th><th>W1 Pre</th><th>W1 Post</th><th>W2 Pre</th><th>W2 Post</th></tr>
                ${group.metrics.map(m => {
                    const w1Pre = parseFloat(rawData[0][m]) || NaN;
                    const w1Post = parseFloat(rawData[1][m]) || NaN;
                    const w2Pre = parseFloat(rawData[3][m]) || NaN;
                    const w2Post = parseFloat(rawData[4][m]) || NaN;
                    return `
                        <tr>
                            <td>${m}</td>
                            <td>${isNaN(w1Pre)?'-':w1Pre.toFixed(2)}</td>
                            <td>${isNaN(w1Post)?'-':w1Post.toFixed(2)}</td>
                            <td>${isNaN(w2Pre)?'-':w2Pre.toFixed(2)}</td>
                            <td>${isNaN(w2Post)?'-':w2Post.toFixed(2)}</td>
                        </tr>`;
                }).join('')}
            </table>`;
        outputDiv.innerHTML += tableHTML;

        const chartBlock = document.createElement('div');
        chartBlock.className = 'chart-block';
        const canvas = document.createElement('canvas');
        chartBlock.appendChild(canvas);
        chartsContainer.appendChild(chartBlock);

        new Chart(canvas, {
            type: 'bar',
            data: {
                labels: group.metrics,
                datasets: [
                    { label: 'W1 Pre', data: group.metrics.map(m => parseFloat(rawData[0][m]) || NaN), backgroundColor: '#ff6384' },
                    { label: 'W1 Post', data: group.metrics.map(m => parseFloat(rawData[1][m]) || NaN), backgroundColor: '#ff3864' },
                    { label: 'W2 Pre', data: group.metrics.map(m => parseFloat(rawData[3][m]) || NaN), backgroundColor: '#36a2eb' },
                    { label: 'W2 Post', data: group.metrics.map(m => parseFloat(rawData[4][m]) || NaN), backgroundColor: '#3677eb' }
                ]
            },
            options: { responsive: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    });

    Sortable.create(chartsContainer, { animation: 150 });
}

document.getElementById('saveConfigBtn').addEventListener('click', () => {
    const configName = prompt('Enter a name for this configuration:');
    if (!configName) return;

    const groups = [];
    document.querySelectorAll('#groupsPanel .group').forEach(g => {
        const name = g.querySelector('.group-name').textContent;
        const metrics = Array.from(g.querySelectorAll('.metrics-item')).map(li => li.textContent);
        if (metrics.length > 0) groups.push({ name, metrics });
    });

    let configs = JSON.parse(localStorage.getItem('configs') || '{}');
    configs[configName] = groups;
    localStorage.setItem('configs', JSON.stringify(configs));
    updateConfigDropdown();
    alert('Configuration saved!');
});

document.getElementById('loadConfigBtn').addEventListener('click', () => {
    const selected = document.getElementById('configSelect').value;
    if (!selected) {
        alert('Please select a configuration to load.');
        return;
    }

    const configs = JSON.parse(localStorage.getItem('configs') || '{}');
    const config = configs[selected];
    if (!config) return;

    // Clear groups
    document.getElementById('groupsPanel').innerHTML = '<h3>Groups</h3><button id="addGroupBtn" style="margin-bottom:10px;">+ Add Group</button>';
    populateMetrics();

    config.forEach(g => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'group';
        groupDiv.innerHTML = `
            <div class="group-header">
                <span class="group-name">${g.name}</span>
                <button class="delete-group">✖</button>
            </div>
            <ul class="metric-list"></ul>
        `;

        groupDiv.querySelector('.delete-group').addEventListener('click', () => {
            const metricsToReturn = groupDiv.querySelectorAll('.metrics-item');
            metricsToReturn.forEach(item => document.getElementById('unassigned').appendChild(item));
            groupDiv.remove();
        });

        document.getElementById('groupsPanel').insertBefore(groupDiv, document.getElementById('addGroupBtn'));

        g.metrics.forEach(m => {
            const metricLi = [...document.querySelectorAll('.metrics-item')].find(li => li.textContent === m);
            if (metricLi) groupDiv.querySelector('.metric-list').appendChild(metricLi);
        });
    });

    enableDragDrop();
    document.getElementById('addGroupBtn').addEventListener('click', () => {
        const name = prompt('Enter group name:');
        if (!name) return;
        const groupDiv = document.createElement('div');
        groupDiv.className = 'group';
        groupDiv.innerHTML = `
            <div class="group-header">
                <span class="group-name">${name}</span>
                <button class="delete-group">✖</button>
            </div>
            <ul class="metric-list"></ul>
        `;
        groupDiv.querySelector('.delete-group').addEventListener('click', () => {
            const metricsToReturn = groupDiv.querySelectorAll('.metrics-item');
            metricsToReturn.forEach(item => document.getElementById('unassigned').appendChild(item));
            groupDiv.remove();
        });
        document.getElementById('groupsPanel').insertBefore(groupDiv, document.getElementById('addGroupBtn'));
        enableDragDrop();
    });
});

function updateConfigDropdown() {
    const configs = JSON.parse(localStorage.getItem('configs') || '{}');
    const select = document.getElementById('configSelect');
    select.innerHTML = '<option value="">Select Configuration</option>';
    Object.keys(configs).forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
    });
}

// Load configs on page load
updateConfigDropdown();

document.getElementById('exportPDFBtn').addEventListener('click', async () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'pt', 'a4');
    const section = document.getElementById('outputSection');
    const canvas = await html2canvas(section, { scale: 2 });
    const imgData = canvas.toDataURL('image/png');
    const imgWidth = 595; // A4 width in pt
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
    pdf.save('comparison.pdf');
});
</script>
</body>
</html>
