<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Compare Weeks</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin-top: 20px;
    }
    #drop-zone {
      border: 2px dashed #ccc;
      padding: 20px;
      margin: 20px;
      width: 90%;
      text-align: center;
    }
    #controls {
      display: flex;
      justify-content: space-between;
      width: 90%;
      margin: 10px 0;
    }
    #metric-list, #group-list {
      display: inline-block;
      vertical-align: top;
      width: 45%;
      border: 1px solid #ccc;
      min-height: 200px;
      padding: 10px;
    }
    .group {
      margin: 10px 0;
      border: 1px solid #aaa;
      padding: 10px;
      background-color: #f9f9f9;
    }
    .group-header {
      display: flex;
      justify-content: space-between;
      font-weight: bold;
      background-color: #e0e0e0;
      padding: 5px;
    }
    .metric-item {
      margin: 5px;
      padding: 5px;
      background-color: #eaeaea;
      cursor: move;
    }
    #graphs-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
      width: 100%;
    }
    .graph-box {
      margin: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      background-color: #fff;
      width: 90%;
    }
    .tables-container {
      display: flex;
      justify-content: center;
      width: 100%;
    }
    table {
      margin: 10px;
      border-collapse: collapse;
      width: 45%;
    }
    th, td {
      border: 1px solid #000;
      padding: 5px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Week Comparison Tool</h1>
  <div id="drop-zone">Drag and drop your CSV file here</div>

  <div id="controls">
    <button onclick="generateComparison()">Generate Comparison</button>
    <button onclick="saveConfiguration()">Save Configuration</button>
    <button onclick="loadConfiguration()">Load Configuration</button>
  </div>

  <div id="configuration">
    <div id="metric-list"></div>
    <div id="group-list">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <label><strong>Groups</strong></label>
        <button onclick="addGroup()">+ Add Group</button>
      </div>
      <div id="groups"></div>
    </div>
  </div>

  <div id="graphs-container"></div>
  <div class="tables-container">
    <div id="week1-table"></div>
    <div id="week2-table"></div>
  </div>
  <button id="export-pdf" style="display:none;" onclick="exportToPDF()">Save PDF</button>

  <script>
    let csvData;
    let config = { groups: [] };

    document.getElementById('drop-zone').addEventListener('dragover', e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
    });
    document.getElementById('drop-zone').addEventListener('drop', e => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: results => {
          csvData = results.data;
          populateMetricList();
        }
      });
    });

    function populateMetricList() {
      const metricList = document.getElementById('metric-list');
      metricList.innerHTML = '';
      const keys = Object.keys(csvData[0]);
      keys.forEach(key => {
        const div = document.createElement('div');
        div.className = 'metric-item';
        div.draggable = true;
        div.textContent = key;
        div.ondragstart = e => {
          e.dataTransfer.setData('text/plain', key);
        };
        metricList.appendChild(div);
      });
    }

    function addGroup() {
      const groupName = prompt("Enter group name:");
      if (!groupName) return;
      const groupId = Date.now();
      const group = { id: groupId, name: groupName, metrics: [] };
      config.groups.unshift(group);
      renderGroups();
    }

    function renderGroups() {
      const groupsDiv = document.getElementById('groups');
      groupsDiv.innerHTML = '';
      config.groups.forEach(group => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'group';
        groupDiv.ondragover = e => e.preventDefault();
        groupDiv.ondrop = e => {
          const metric = e.dataTransfer.getData('text/plain');
          if (!group.metrics.includes(metric)) group.metrics.push(metric);
          renderGroups();
        };

        const header = document.createElement('div');
        header.className = 'group-header';
        header.innerHTML = `
          <span>${group.name}</span>
          <button onclick="deleteGroup(${group.id})">Delete</button>
        `;
        groupDiv.appendChild(header);

        group.metrics.forEach(m => {
          const div = document.createElement('div');
          div.className = 'metric-item';
          div.textContent = m;
          groupDiv.appendChild(div);
        });

        groupsDiv.appendChild(groupDiv);
      });
    }

    function deleteGroup(id) {
      config.groups = config.groups.filter(g => g.id !== id);
      renderGroups();
    }

    function generateComparison() {
      document.getElementById('export-pdf').style.display = 'block';
      document.getElementById('configuration').style.display = 'none';
      const week1 = [], week2 = [];
      const dates = [...new Set(csvData.map(row => row['date of assessment']))].sort();
      const mid = Math.floor(dates.length / 2);
      const week1Dates = new Set(dates.slice(0, mid));
      const week2Dates = new Set(dates.slice(mid));
      csvData.forEach(row => {
        if (week1Dates.has(row['date of assessment'])) week1.push(row);
        else week2.push(row);
      });

      generateTables(week1, 'week1-table');
      generateTables(week2, 'week2-table');

      const graphsContainer = document.getElementById('graphs-container');
      graphsContainer.innerHTML = '';
      config.groups.forEach(group => {
        const div = document.createElement('div');
        div.className = 'graph-box';
        const canvas = document.createElement('canvas');
        div.innerHTML = `<h3>${group.name}</h3>`;
        div.appendChild(canvas);
        graphsContainer.appendChild(div);

        const labels = group.metrics;
        const data1 = labels.map(label => average(week1.map(r => parseFloat(r[label]))));
        const data2 = labels.map(label => average(week2.map(r => parseFloat(r[label]))));

        new Chart(canvas, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { label: 'Week 1', data: data1, backgroundColor: 'blue' },
              { label: 'Week 2', data: data2, backgroundColor: 'orange' }
            ]
          },
          options: {
            plugins: { legend: { position: 'top' } },
            scales: { y: { beginAtZero: true } }
          }
        });
      });
    }

    function average(arr) {
      const valid = arr.filter(v => !isNaN(v));
      return valid.length ? (valid.reduce((a,b) => a + b, 0) / valid.length).toFixed(2) : '';
    }

    function generateTables(data, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      config.groups.forEach(group => {
        const table = document.createElement('table');
        const titleRow = document.createElement('tr');
        const titleCell = document.createElement('th');
        titleCell.colSpan = group.metrics.length + 1;
        titleCell.textContent = group.name;
        titleRow.appendChild(titleCell);
        table.appendChild(titleRow);

        const header = document.createElement('tr');
        header.innerHTML = '<th>Date</th>' + group.metrics.map(m => `<th>${m}</th>`).join('');
        table.appendChild(header);

        data.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${row['date of assessment']}</td>` + group.metrics.map(m => `<td>${parseFloat(row[m] || '').toFixed(2) || ''}</td>`).join('');
          table.appendChild(tr);
        });

        container.appendChild(table);
      });
    }

    function saveConfiguration() {
      const name = prompt("Enter configuration name:");
      if (!name) return;
      localStorage.setItem(name, JSON.stringify(config));
      alert("Configuration saved.");
    }

    function loadConfiguration() {
      const name = prompt("Enter configuration name to load:");
      if (!name) return;
      const conf = localStorage.getItem(name);
      if (conf) {
        config = JSON.parse(conf);
        renderGroups();
        alert("Configuration loaded.");
      } else {
        alert("No configuration found.");
      }
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape' });
      doc.html(document.body, {
        callback: function (pdf) {
          pdf.save('comparison.pdf');
        },
        x: 10,
        y: 10,
        width: 280
      });
    }
  </script>
</body>
</html>
