<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Custom Week Comparison</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h2 { margin-bottom: 10px; }
#dropZone {
    border: 2px dashed #999;
    padding: 20px;
    text-align: center;
    background: #f9f9f9;
    margin-bottom: 20px;
    cursor: pointer;
}
.flex-container { display: flex; gap: 20px; margin-top: 20px; }
.panel {
    flex: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background: #fafafa;
    min-height: 300px;
}
.metric-list {
    list-style: none;
    padding: 0;
    min-height: 50px;
}
.metrics-item {
    background: #fff;
    border: 1px solid #ccc;
    padding: 6px;
    margin-bottom: 5px;
    cursor: grab;
}
.group {
    border: 1px solid #ccc;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 6px;
    background: #fff;
}
.group-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}
.group-header span {
    cursor: pointer;
}
.delete-group {
    background: #ff4d4d;
    color: white;
    border: none;
    padding: 3px 8px;
    cursor: pointer;
    border-radius: 4px;
}
.drag-over { background: #e6f7ff; }
#output { margin-top: 20px; }
.tables-container { display: flex; gap: 20px; flex-wrap: wrap; }
table { border-collapse: collapse; width: 100%; max-width: 600px; font-size: 14px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #f4f4f4; }
#chartsContainer { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; justify-content: center; }
.chart-block {
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 6px;
    background: #fff;
    position: relative;
}
.delete-chart {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #ff4d4d;
    color: #fff;
    border: none;
    padding: 3px 6px;
    cursor: pointer;
    border-radius: 4px;
}
#chartsContainer canvas { background: #fff; padding: 5px; border-radius: 6px; width: 350px !important; height: 250px !important; }
.legend { text-align: center; margin-top: 10px; display: none; }
.legend span { margin: 0 10px; }
#addGroupBtn {
    width: 100%;
    margin-top: 10px;
    background: #007bff;
    color: #fff;
    border: none;
    padding: 8px;
    cursor: pointer;
    border-radius: 4px;
}
#generateBtn, #saveConfigBtn, #loadConfigBtn {
    margin-top: 10px;
    padding: 8px 12px;
    background: #28a745;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
#saveConfigBtn, #loadConfigBtn {
    background: #6c757d;
}
</style>
</head>
<body>

<h2>Upload CSV File</h2>
<div id="dropZone">Drag & Drop CSV Here or Click to Upload</div>
<input type="file" id="csvFile" accept=".csv" style="display:none;" />

<div class="flex-container">
    <div class="panel">
        <h3>Available Metrics</h3>
        <ul id="unassigned" class="metric-list"></ul>
    </div>
    <div class="panel" id="groupsPanel">
        <h3>Groups</h3>
        <button id="addGroupBtn">+ Add Group</button>
    </div>
</div>

<div style="margin-top:15px;">
    <button id="generateBtn">Generate Comparison</button>
    <button id="saveConfigBtn">Save Configuration</button>
    <button id="loadConfigBtn">Load Configuration</button>
</div>

<div id="output"></div>
<div id="chartsContainer"></div>
<div class="legend" id="legend">
    <span style="color:#ff6384;">■ Week 1 Pre</span>
    <span style="color:#ff3864;">■ Week 1 Post</span>
    <span style="color:#36a2eb;">■ Week 2 Pre</span>
    <span style="color:#3677eb;">■ Week 2 Post</span>
</div>

<script>
let rawData = [], headers = [];

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('csvFile');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.background="#eef"; });
dropZone.addEventListener('dragleave', () => dropZone.style.background="#f9f9f9");
dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.style.background="#f9f9f9";
    handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

function handleFile(file) {
    Papa.parse(file, {
        header: true,
        complete: function(results) {
            headers = results.meta.fields;
            rawData = results.data.filter(r => r[headers[0]]);
            populateMetrics();
        }
    });
}

function populateMetrics() {
    const ul = document.getElementById('unassigned');
    ul.innerHTML = '';
    headers.slice(1).forEach((h, i) => {
        const li = createMetricItem(h, i);
        ul.appendChild(li);
    });
    enableDragDrop();
}

function createMetricItem(name, id) {
    const li = document.createElement('li');
    li.textContent = name;
    li.className = 'metrics-item';
    li.setAttribute('draggable', 'true');
    li.dataset.id = id;
    li.addEventListener('dblclick', () => {
        const newName = prompt('Rename metric:', li.textContent);
        if (newName) li.textContent = newName;
    });
    return li;
}

document.getElementById('addGroupBtn').addEventListener('click', () => {
    const name = prompt('Enter group name:');
    if (!name) return;
    const groupDiv = document.createElement('div');
    groupDiv.className = 'group';
    groupDiv.innerHTML = `
        <div class="group-header">
            <span class="group-name">${name}</span>
            <button class="delete-group">✖</button>
        </div>
        <ul class="metric-list"></ul>
    `;
    const deleteBtn = groupDiv.querySelector('.delete-group');
    deleteBtn.addEventListener('click', () => {
        const metricsToReturn = groupDiv.querySelectorAll('.metrics-item');
        metricsToReturn.forEach(item => document.getElementById('unassigned').appendChild(item));
        groupDiv.remove();
    });
    const nameSpan = groupDiv.querySelector('.group-name');
    nameSpan.addEventListener('dblclick', () => {
        const newName = prompt('Rename group:', nameSpan.textContent);
        if (newName) nameSpan.textContent = newName;
    });
    document.getElementById('groupsPanel').insertBefore(groupDiv, document.getElementById('addGroupBtn'));
    enableDragDrop();
});

function enableDragDrop() {
    document.querySelectorAll('.metrics-item').forEach(item => {
        item.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', item.dataset.id));
    });

    document.querySelectorAll('.metric-list').forEach(list => {
        list.addEventListener('dragover', e => { e.preventDefault(); list.classList.add('drag-over'); });
        list.addEventListener('dragleave', () => list.classList.remove('drag-over'));
        list.addEventListener('drop', e => {
            e.preventDefault();
            const id = e.dataTransfer.getData('text/plain');
            const dragged = document.querySelector(`.metrics-item[data-id="${id}"]`);
            if (dragged) list.appendChild(dragged);
            list.classList.remove('drag-over');
        });
    });
}

document.getElementById('generateBtn').addEventListener('click', () => {
    const groups = [];
    document.querySelectorAll('#groupsPanel .group').forEach(g => {
        const name = g.querySelector('.group-name').textContent;
        const metrics = Array.from(g.querySelectorAll('.metrics-item')).map(li => li.textContent);
        if (metrics.length > 0) groups.push({ name, metrics });
    });
    if (groups.length > 0) document.getElementById('legend').style.display = 'block';
    buildTablesCharts(groups);
});

function buildTablesCharts(groups) {
    const outputDiv = document.getElementById('output');
    const chartsContainer = document.getElementById('chartsContainer');
    outputDiv.innerHTML = '';
    chartsContainer.innerHTML = '';

    groups.forEach(group => {
        const tableHTML = `
            <h3>${group.name}</h3>
            <table>
                <tr><th>Metric</th><th>W1 Pre</th><th>W1 Post</th><th>W2 Pre</th><th>W2 Post</th></tr>
                ${group.metrics.map(m => {
                    const w1Pre = parseFloat(rawData[0][m]) || NaN;
                    const w1Post = parseFloat(rawData[1][m]) || NaN;
                    const w2Pre = parseFloat(rawData[3][m]) || NaN;
                    const w2Post = parseFloat(rawData[4][m]) || NaN;
                    return `
                        <tr>
                            <td>${m}</td>
                            <td>${isNaN(w1Pre)?'-':w1Pre.toFixed(2)}</td>
                            <td>${isNaN(w1Post)?'-':w1Post.toFixed(2)}</td>
                            <td>${isNaN(w2Pre)?'-':w2Pre.toFixed(2)}</td>
                            <td>${isNaN(w2Post)?'-':w2Post.toFixed(2)}</td>
                        </tr>`;
                }).join('')}
            </table>`;
        outputDiv.innerHTML += tableHTML;

        const labels = group.metrics;
        const w1PreVals = group.metrics.map(m => parseFloat(rawData[0][m]) || NaN);
        const w1PostVals = group.metrics.map(m => parseFloat(rawData[1][m]) || NaN);
        const w2PreVals = group.metrics.map(m => parseFloat(rawData[3][m]) || NaN);
        const w2PostVals = group.metrics.map(m => parseFloat(rawData[4][m]) || NaN);

        const chartBlock = document.createElement('div');
        chartBlock.className = 'chart-block';
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-chart';
        deleteBtn.textContent = '✖';
        deleteBtn.addEventListener('click', () => chartBlock.remove());
        chartBlock.appendChild(deleteBtn);

        const canvas = document.createElement('canvas');
        chartBlock.appendChild(canvas);
        chartsContainer.appendChild(chartBlock);

        new Chart(canvas, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: 'W1 Pre', data: w1PreVals, backgroundColor: '#ff6384' },
                    { label: 'W1 Post', data: w1PostVals, backgroundColor: '#ff3864' },
                    { label: 'W2 Pre', data: w2PreVals, backgroundColor: '#36a2eb' },
                    { label: 'W2 Post', data: w2PostVals, backgroundColor: '#3677eb' }
                ]
            },
            options: { responsive: false, scales: { y: { beginAtZero: true } } }
        });
    });
}

// Save configuration
document.getElementById('saveConfigBtn').addEventListener('click', () => {
    const config = [];
    document.querySelectorAll('#groupsPanel .group').forEach(g => {
        const name = g.querySelector('.group-name').textContent;
        const metrics = Array.from(g.querySelectorAll('.metrics-item')).map(li => li.textContent);
        config.push({ name, metrics });
    });
    localStorage.setItem('weekCompareConfig', JSON.stringify(config));
    alert('Configuration saved!');
});

// Load configuration
document.getElementById('loadConfigBtn').addEventListener('click', () => {
    const config = JSON.parse(localStorage.getItem('weekCompareConfig') || '[]');
    if (config.length === 0) return alert('No configuration found!');
    document.querySelectorAll('#groupsPanel .group').forEach(g => g.remove());
    config.forEach(c => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'group';
        groupDiv.innerHTML = `
            <div class="group-header">
                <span class="group-name">${c.name}</span>
                <button class="delete-group">✖</button>
            </div>
            <ul class="metric-list"></ul>
        `;
        const deleteBtn = groupDiv.querySelector('.delete-group');
        deleteBtn.addEventListener('click', () => {
            const metricsToReturn = groupDiv.querySelectorAll('.metrics-item');
            metricsToReturn.forEach(item => document.getElementById('unassigned').appendChild(item));
            groupDiv.remove();
        });
        const nameSpan = groupDiv.querySelector('.group-name');
        nameSpan.addEventListener('dblclick', () => {
            const newName = prompt('Rename group:', nameSpan.textContent);
            if (newName) nameSpan.textContent = newName;
        });
        const ul = groupDiv.querySelector('.metric-list');
        c.metrics.forEach(m => {
            const li = createMetricItem(m, Date.now());
            ul.appendChild(li);
        });
        document.getElementById('groupsPanel').insertBefore(groupDiv, document.getElementById('addGroupBtn'));
    });
    enableDragDrop();
});
</script>
</body>
</html>
