<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dynamic Week Comparison</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h2 { margin-top: 20px; }

  /* Drag and drop */
  #dropZone {
    width: 100%; padding: 20px; text-align: center;
    border: 2px dashed #aaa; border-radius: 8px; color: #555;
    margin-bottom: 15px;
  }
  #dropZone.dragover { background: #eef; }

  .controls { margin-top: 20px; }
  .controls label { display: block; margin: 8px 0 4px; }

  .metrics-container {
    display: flex; gap: 20px; margin-top: 15px;
  }
  .metrics-list, .groups-list {
    border: 1px solid #ccc; border-radius: 6px; padding: 10px;
    width: 45%; min-height: 200px;
  }
  .metrics-item {
    padding: 5px; margin: 4px 0; background: #f4f4f4; cursor: grab; border-radius: 4px;
  }
  .group-box {
    border: 2px dashed #bbb; border-radius: 6px; padding: 10px;
    margin-bottom: 10px;
  }
  .group-title { font-weight: bold; margin-bottom: 5px; }

  table { border-collapse: collapse; width: 100%; font-size: 14px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  th { background: #f4f4f4; }

  .tables-container { display: flex; gap: 20px; margin-top: 20px; }
  .table-section { flex: 1; }

  #chartsContainer { margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
  #chartsContainer canvas { background: #fff; padding: 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

  #legend { text-align: center; margin-top: 15px; font-weight: bold; }
  #saveBtn { margin-top: 20px; padding: 10px 15px; }
</style>
</head>
<body>
<h2>Compare Weeks</h2>

<div id="dropZone">Drag & Drop CSV here or click to upload<input type="file" id="fileInput" accept=".csv" style="display:none;"></div>

<div class="controls" id="setupControls" style="display:none;">
  <label>Rows per week: <input type="number" id="rowsPerWeek" value="3" style="width:60px;"></label>
  <label>Session Labels (comma-separated): <input type="text" id="sessionLabels" value="Pre,Post,Follow-up" style="width:300px;"></label>
  <button id="configureBtn">Configure Metrics</button>
</div>

<div id="metricSelection" style="display:none;">
  <h3>Step 2: Organize Metrics (Drag to Groups)</h3>
  <div class="metrics-container">
    <div class="metrics-list" id="metricsList"><strong>Available Metrics</strong></div>
    <div class="groups-list" id="groupsList">
      <button id="addGroupBtn">+ Add Group</button>
    </div>
  </div>
  <button id="generateBtn" style="margin-top:15px;">Generate Tables & Charts</button>
</div>

<div id="output"></div>
<div id="chartsContainer"></div>
<div id="legend"></div>
<button id="saveBtn" style="display:none;">Save as PDF</button>

<script>
let parsedData = [];
let headers = [];
let groups = [];
const chartColors = ['#ff6384','#ff80a0','#36a2eb','#5da6f2'];

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('click', ()=>fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', ()=>dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

function handleFile(file){
  Papa.parse(file,{header:true,complete:function(res){
    parsedData = res.data.filter(row => Object.values(row).some(val => val.trim() !== ''));
    headers = res.meta.fields;
    document.getElementById('setupControls').style.display='block';
  }});
}

document.getElementById('configureBtn').addEventListener('click',()=>{
  const metricsList = document.getElementById('metricsList');
  metricsList.innerHTML='<strong>Available Metrics</strong>';
  headers.forEach(h=>{
    metricsList.innerHTML += `<div class="metrics-item" draggable="true" data-metric="${h}">${h}</div>`;
  });
  document.getElementById('metricSelection').style.display='block';
  enableDragDrop();
});

document.getElementById('addGroupBtn').addEventListener('click',()=>{
  const groupId = 'group'+(groups.length+1);
  groups.push({id:groupId,name:'Group '+(groups.length+1),metrics:[]});
  const gDiv = document.createElement('div');
  gDiv.className='group-box';
  gDiv.id=groupId;
  gDiv.innerHTML=`<div class="group-title" contenteditable="true">Group ${groups.length}</div><div class="dropzone"></div>`;
  document.getElementById('groupsList').appendChild(gDiv);
  enableDragDrop();
});

function enableDragDrop() {
  const metricsContainer = document.getElementById('metricSelection');

  metricsContainer.addEventListener('dragstart', e => {
    if (e.target.classList.contains('metrics-item')) {
      e.dataTransfer.setData('text/plain', e.target.dataset.metric);
      e.target.classList.add('dragging');
    }
  });

  metricsContainer.addEventListener('dragend', e => {
    if (e.target.classList.contains('metrics-item')) {
      e.target.classList.remove('dragging');
    }
  });

  metricsContainer.addEventListener('dragover', e => {
    if (e.target.classList.contains('dropzone') || e.target.id === 'metricsList') {
      e.preventDefault();
    }
  });

  metricsContainer.addEventListener('drop', e => {
    e.preventDefault();
    const metric = e.dataTransfer.getData('text/plain');
    let dropTarget = e.target;

    // If dropping on a child, move to parent container
    if (!dropTarget.classList.contains('dropzone') && dropTarget.id !== 'metricsList') {
      dropTarget = dropTarget.closest('.dropzone') || dropTarget.closest('#metricsList');
    }

    if (dropTarget && !dropTarget.querySelector(`[data-metric="${metric}"]`)) {
      // Remove from old parent
      const draggedItem = metricsContainer.querySelector(`.metrics-item[data-metric="${metric}"]`);
      if (draggedItem) draggedItem.remove();

      // Add to new parent
      dropTarget.insertAdjacentHTML('beforeend',
        `<div class="metrics-item" draggable="true" data-metric="${metric}">${metric}</div>`
      );

      updateGroups();
    }
  });
}

function enableInlineEdit() {
  const metricsContainer = document.getElementById('metricSelection');

  metricsContainer.addEventListener('dblclick', e => {
    if (e.target.classList.contains('metrics-item')) {
      const currentName = e.target.textContent;
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentName;
      input.style.width = '90%';
      input.classList.add('edit-input');

      e.target.innerHTML = '';
      e.target.appendChild(input);
      input.focus();

      input.addEventListener('blur', () => saveName(e.target, input.value));
      input.addEventListener('keydown', ev => {
        if (ev.key === 'Enter') saveName(e.target, input.value);
      });
    }
  });

  function saveName(container, newName) {
    newName = newName.trim();
    if (newName === '') newName = 'Unnamed Metric';
    container.dataset.metric = newName;
    container.textContent = newName;
    updateGroups();
  }
}

function updateGroups(){
  groups.forEach(g=>{
    const div=document.getElementById(g.id);
    g.name=div.querySelector('.group-title').innerText;
    g.metrics=[...div.querySelectorAll('.metrics-item')].map(m=>m.dataset.metric);
  });
}

document.getElementById('generateBtn').addEventListener('click',()=>{
  updateGroups();
  generateTablesAndCharts();
  document.getElementById('saveBtn').style.display='block';
});

function generateTablesAndCharts(){
  const rowsPerWeek=parseInt(document.getElementById('rowsPerWeek').value);
  const sessionLabels=document.getElementById('sessionLabels').value.split(',').map(s=>s.trim());
  const numWeeks=Math.floor(parsedData.length/rowsPerWeek);
  
  const output=document.getElementById('output');
  output.innerHTML='';
  const chartsContainer=document.getElementById('chartsContainer');
  chartsContainer.innerHTML='';
  
  groups.forEach(g=>{
    let tablesHTML=`<h3>${g.name}</h3><div class="tables-container">`;
    for(let w=0;w<numWeeks;w++){
      const weekRows=parsedData.slice(w*rowsPerWeek,(w+1)*rowsPerWeek);
      tablesHTML+=`<div class="table-section"><h4>Week ${w+1}</h4><table><tr><th>Metric</th>${sessionLabels.map(l=>`<th>${l}</th>`).join('')}</tr>`;
      g.metrics.forEach(m=>{
        tablesHTML+=`<tr><td>${m}</td>`;
        sessionLabels.forEach((_,i)=>{
          const val=parseFloat(weekRows[i][m]);
          tablesHTML+=`<td>${isNaN(val)?'-':val.toFixed(2)}</td>`;
        });
        tablesHTML+='</tr>';
      });
      tablesHTML+='</table></div>';
    }
    tablesHTML+='</div>';
    output.innerHTML+=tablesHTML;

    const labels=g.metrics;
    const datasets=[];
    for(let w=0;w<numWeeks;w++){
      sessionLabels.forEach((label,i)=>{
        const weekRows=parsedData.slice(w*rowsPerWeek,(w+1)*rowsPerWeek);
        datasets.push({
          label:`Week ${w+1} - ${label}`,
          data:g.metrics.map(m=>parseFloat(weekRows[i][m])||0),
          backgroundColor: chartColors[(w*sessionLabels.length+i)%chartColors.length]
        });
      });
    }
    const canvas=document.createElement('canvas');
    chartsContainer.appendChild(canvas);
    new Chart(canvas,{
      type:'bar',
      data:{labels:labels,datasets:datasets},
      options:{
        responsive:true,
        plugins:{legend:{display:false},title:{display:true,text:g.name}},
        scales:{x:{stacked:false},y:{beginAtZero:true}}
      }
    });
  });

  document.getElementById('legend').innerHTML='Global Legend: '+groups.map((_,idx)=>`<span style="color:${chartColors[idx%chartColors.length]}">â–  Week ${idx+1}</span>`).join(' ');
}

document.getElementById('saveBtn').addEventListener('click',async()=>{
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF('landscape','pt','a4');
  const pageWidth=doc.internal.pageSize.getWidth();
  const pageHeight=doc.internal.pageSize.getHeight();

  const combinedElement=document.createElement('div');
  combinedElement.appendChild(document.getElementById('output').cloneNode(true));
  const combinedCanvas=await html2canvas(combinedElement,{scale:2});
  const imgDataCombined=combinedCanvas.toDataURL('image/png');
  const imgWidthCombined=pageWidth-40;
  const imgHeightCombined=(combinedCanvas.height*imgWidthCombined)/combinedCanvas.width;
  doc.addImage(imgDataCombined,'PNG',20,20,imgWidthCombined,imgHeightCombined);

  doc.addPage('a4','landscape');
  const chartsCanvas=await html2canvas(document.getElementById('chartsContainer'),{scale:2});
  const imgDataCharts=chartsCanvas.toDataURL('image/png');
  const imgWidthCharts=pageWidth-40;
  const imgHeightCharts=pageHeight-40;
  doc.addImage(imgDataCharts,'PNG',20,20,imgWidthCharts,imgHeightCharts);

  doc.save('comparison_report.pdf');
});
</script>
</body>
</html>
