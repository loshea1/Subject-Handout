<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Custom Week Comparison</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h2, h3 { margin-top: 20px; }
  #dropZone {
    border: 2px dashed #999;
    padding: 20px;
    text-align: center;
    margin-bottom: 20px;
    background: #f9f9f9;
    cursor: pointer;
  }
  .tables-container { display: flex; gap: 20px; flex-wrap: wrap; }
  table { border-collapse: collapse; width: 100%; max-width: 600px; font-size: 14px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; white-space: nowrap; }
  th { background: #f4f4f4; }
  .group { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 6px; background: #fefefe; }
  .group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
  .delete-group { background: #ff4d4d; color: white; border: none; padding: 3px 8px; cursor: pointer; border-radius: 4px; }
  .metric-list { list-style: none; padding: 0; margin: 0; }
  .metrics-item { padding: 5px; border: 1px solid #ccc; margin: 2px 0; background: #fafafa; cursor: grab; }
  .drag-over { background: #d0f0ff; }
  #chartsContainer { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; justify-content: center; }
  #chartsContainer canvas { background: #fff; padding: 5px; border-radius: 6px; width: 350px !important; height: 250px !important; }
  .legend { text-align: center; margin-top: 10px; font-size: 14px; }
  .legend span { margin: 0 10px; }
  #saveBtn { margin-top: 20px; padding: 10px 15px; }
</style>
</head>
<body>

<h2>Upload CSV File</h2>
<div id="dropZone">Drag and Drop CSV Here or Click to Upload</div>
<input type="file" id="csvFile" accept=".csv" style="display:none;" />

<div>
  <label>Week 1 Dates (comma separated):</label><br>
  <input type="text" id="week1Dates" placeholder="e.g. 2025-07-01,2025-07-02"><br><br>
  <label>Week 2 Dates (comma separated):</label><br>
  <input type="text" id="week2Dates" placeholder="e.g. 2025-07-15,2025-07-16">
</div>

<h3>Organize Metrics</h3>
<div id="metricSelection"></div>

<div id="output"></div>
<div id="summary" class="summary"></div>
<div id="chartsContainer"></div>
<div class="legend">
  <span style="color:#ff6384;">■ Week 1 Pre</span>
  <span style="color:#ff3864;">■ Week 1 Post</span>
  <span style="color:#36a2eb;">■ Week 2 Pre</span>
  <span style="color:#3677eb;">■ Week 2 Post</span>
</div>

<button id="saveBtn">Save as PDF</button>
<p id="saveMsg" style="color: green; font-weight: bold;"></p>

<script>
let rawData = [], headers = [];
let groups = []; // [{name:"Group", metrics:["metric1","metric2"]}]

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('csvFile');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.background="#eef"; });
dropZone.addEventListener('dragleave', () => dropZone.style.background="#f9f9f9");
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.style.background="#f9f9f9";
  handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

function handleFile(file) {
  Papa.parse(file, {
    header: true,
    complete: function(results) {
      headers = results.meta.fields;
      rawData = results.data.filter(r => r[headers[0]]); // remove empty rows
      initMetricSelection();
    }
  });
}

function initMetricSelection() {
  const container = document.getElementById('metricSelection');
  container.innerHTML = "<h4>Drag metrics into groups (Double-click to rename metric)</h4>";

  const unassignedDiv = document.createElement('div');
  unassignedDiv.className = 'group';
  unassignedDiv.innerHTML = `<div class="group-header"><span class="group-name">Unassigned</span></div><ul class="metric-list" id="unassigned"></ul>`;
  container.appendChild(unassignedDiv);

  headers.forEach(h => {
    const li = document.createElement('li');
    li.textContent = h;
    li.className = 'metrics-item';
    li.setAttribute('draggable', 'true');
    li.addEventListener('dblclick', () => {
      const newName = prompt('Rename metric:', li.textContent);
      if (newName) li.textContent = newName;
    });
    unassignedDiv.querySelector('.metric-list').appendChild(li);
  });

  enableDragDrop();
  addGroupButton();
}

function addGroupButton() {
  const btn = document.createElement('button');
  btn.textContent = "Add Group";
  btn.style.margin = "10px 0";
  btn.onclick = () => {
    const name = prompt('Enter new group name:');
    if (name) {
      const groupDiv = document.createElement('div');
      groupDiv.className = 'group';
      groupDiv.innerHTML = `
        <div class="group-header">
          <span class="group-name">${name}</span>
          <button class="delete-group">✖</button>
        </div>
        <ul class="metric-list"></ul>
      `;
      document.getElementById('metricSelection').appendChild(groupDiv);

      groupDiv.querySelector('.delete-group').addEventListener('click', () => {
        if (confirm(`Delete group "${name}"?`)) groupDiv.remove();
      });

      enableDragDrop();
    }
  };
  document.getElementById('metricSelection').appendChild(btn);
}

function enableDragDrop() {
  document.querySelectorAll('.metrics-item').forEach(item => {
    item.addEventListener('dragstart', e => e.dataTransfer.setData('text', e.target.textContent));
  });

  document.querySelectorAll('.metric-list').forEach(list => {
    list.addEventListener('dragover', e => { e.preventDefault(); list.classList.add('drag-over'); });
    list.addEventListener('dragleave', () => list.classList.remove('drag-over'));
    list.addEventListener('drop', e => {
      e.preventDefault();
      const text = e.dataTransfer.getData('text');
      const dragged = Array.from(document.querySelectorAll('.metrics-item')).find(el => el.textContent === text);
      if (dragged) list.appendChild(dragged);
      list.classList.remove('drag-over');
    });
  });
}

document.getElementById('saveBtn').addEventListener('click', async function () {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('landscape', 'pt', 'a4');
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();

  const combinedElement = document.createElement('div');
  combinedElement.appendChild(document.getElementById('output').cloneNode(true));
  combinedElement.appendChild(document.getElementById('summary').cloneNode(true));

  const combinedCanvas = await html2canvas(combinedElement, { scale: 2 });
  const imgDataCombined = combinedCanvas.toDataURL('image/png');
  doc.addImage(imgDataCombined, 'PNG', 20, 20, pageWidth - 40, (combinedCanvas.height * (pageWidth - 40)) / combinedCanvas.width);

  doc.addPage();
  const chartsCanvas = await html2canvas(document.getElementById('chartsContainer'), { scale: 2 });
  doc.addImage(chartsCanvas.toDataURL('image/png'), 'PNG', 20, 20, pageWidth - 40, pageHeight - 40);

  doc.save('comparison_report.pdf');
  document.getElementById('saveMsg').textContent = "✅ PDF saved!";
});
</script>
</body>
</html>
