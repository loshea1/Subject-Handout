<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Compare Weeks - Drag & Drop</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h2, h3 { margin-top: 20px; }
  #dropZone {
    border: 3px dashed #888;
    padding: 30px;
    text-align: center;
    color: #666;
    margin-bottom: 20px;
    transition: background 0.3s ease;
  }
  #dropZone.dragover {
    background: #e0f7fa;
    border-color: #00796b;
    color: #00796b;
  }
  #metricSelector { margin: 15px 0; padding: 10px; border: 1px solid #ccc; }
  .metric-option { margin-right: 15px; }
  button { margin: 10px 5px; padding: 10px 15px; }
  table { border-collapse: collapse; width: 100%; margin-top: 15px; font-size: 14px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  th { background: #f4f4f4; }
  .summary { background: #eef; padding: 10px; border-radius: 5px; margin-top: 20px; }
  .green { background: #d4edda; }
  .red { background: #f8d7da; }
  #chartsContainer { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
  #chartsContainer canvas { background: #fff; padding: 5px; border-radius: 6px; width: 300px; height: 200px; }
</style>
</head>
<body>

<h2>Upload CSV to Compare Weeks</h2>

<div id="dropZone">
  <p>Drag & Drop CSV file here OR click to browse</p>
  <input type="file" id="csvFile" accept=".csv" style="display:none;" />
</div>

<div id="metricSelector"></div>
<button id="generateBtn" style="display:none;">Generate Report</button>

<div id="output"></div>
<div id="summary" class="summary"></div>
<div id="chartsContainer"></div>

<!-- Save as PDF -->
<div id="saveSection" style="margin-top:20px;">
  <button id="saveBtn" style="padding:10px 15px; display:none;">Save as PDF</button>
  <p id="saveMsg" style="color: green; font-weight: bold; margin: 0;"></p>
</div>

<script>
let allMetrics = [];
let week1 = [], week2 = [];

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('csvFile');

// Drag & Drop events
dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
});
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.includes("csv")) parseCSV(file);
});
fileInput.addEventListener('change', (e) => parseCSV(e.target.files[0]));

// Parse CSV and show metric selection
function parseCSV(file) {
    Papa.parse(file, {
        header: false,
        complete: function(results) {
            const data = results.data.slice(1); // Skip header row
            week1 = data.slice(0, 3);
            week2 = data.slice(3, 6);

            // Detect metrics dynamically
            const headers = results.data[0];
            allMetrics = headers.map((h, idx) => ({ name: h, col: idx }));

            const selectorDiv = document.getElementById('metricSelector');
            selectorDiv.innerHTML = "<h3>Select Metrics to Compare</h3>";
            allMetrics.forEach((metric, i) => {
                if (i > 1) { // assume first 2 columns are text
                    selectorDiv.innerHTML += `<label class="metric-option"><input type="checkbox" value="${i}" checked> ${metric.name}</label>`;
                }
            });
            document.getElementById('generateBtn').style.display = "inline-block";
        }
    });
}

document.getElementById('generateBtn').addEventListener('click', function() {
    const selectedCols = Array.from(document.querySelectorAll('#metricSelector input:checked')).map(cb => parseInt(cb.value));
    generateReport(selectedCols);
    document.getElementById('saveBtn').style.display = "inline-block";
});

function generateReport(selectedCols) {
    let html = "<h3>Week 1</h3>" + createTable(selectedCols, week1);
    html += "<h3>Week 2</h3>" + createTable(selectedCols, week2);
    document.getElementById('output').innerHTML = html;

    let summaries = [];
    selectedCols.forEach(col => {
        const w1avg = avg(week1.map(r => parseFloat(r[col]) || NaN));
        const w2avg = avg(week2.map(r => parseFloat(r[col]) || NaN));
        if (!isNaN(w1avg) && !isNaN(w2avg)) {
            let diffPercent = ((w2avg - w1avg) / w1avg * 100).toFixed(2);
            let diffText = diffPercent > 0 ? `(+${diffPercent}%)` : `(${diffPercent}%)`;
            summaries.push(`${allMetrics[col].name}: ${w2avg > w1avg ? 'Week 2 higher' : 'Week 1 higher'} (${w1avg.toFixed(2)} vs ${w2avg.toFixed(2)}) ${diffText}`);
        }
    });
    document.getElementById('summary').innerHTML = "<h3>Summary</h3><ul><li>" + summaries.join("</li><li>") + "</li></ul>";

    const chartsContainer = document.getElementById('chartsContainer');
    chartsContainer.innerHTML = "";
    const chartColors = ['#ff66b2', '#ff3399', '#66b2ff', '#3399ff'];

    selectedCols.forEach(col => {
        const canvas = document.createElement('canvas');
        chartsContainer.appendChild(canvas);

        new Chart(canvas, {
            type: 'bar',
            data: {
                labels: ['Pre', 'Post'],
                datasets: [
                    { label: 'Week 1', data: [parseFloat(week1[0][col])||0, parseFloat(week1[1][col])||0], backgroundColor: [chartColors[0], chartColors[1]] },
                    { label: 'Week 2', data: [parseFloat(week2[0][col])||0, parseFloat(week2[1][col])||0], backgroundColor: [chartColors[2], chartColors[3]] }
                ]
            },
            options: {
                responsive: false,
                plugins: {
                    title: { display: true, text: allMetrics[col].name },
                    legend: { position: 'bottom' }
                },
                scales: { y: { beginAtZero: true } }
            }
        });
    });
}

document.getElementById('saveBtn').addEventListener('click', async function () {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape', 'pt', 'a4');
    const pageWidth = doc.internal.pageSize.getWidth();

    const combinedElement = document.createElement('div');
    combinedElement.appendChild(document.getElementById('output').cloneNode(true));
    combinedElement.appendChild(document.getElementById('summary').cloneNode(true));
    const combinedCanvas = await html2canvas(combinedElement, { scale: 2 });
    const imgDataCombined = combinedCanvas.toDataURL('image/png');
    const imgWidthCombined = pageWidth - 40;
    const imgHeightCombined = (combinedCanvas.height * imgWidthCombined) / combinedCanvas.width;
    doc.addImage(imgDataCombined, 'PNG', 20, 20, imgWidthCombined, imgHeightCombined);

    doc.addPage('a4', 'landscape');
    const chartsElement = document.getElementById('chartsContainer');
    const chartsCanvas = await html2canvas(chartsElement, { scale: 2 });
    const imgDataCharts = chartsCanvas.toDataURL('image/png');
    doc.addImage(imgDataCharts, 'PNG', 20, 20, imgWidthCombined, imgHeightCombined);

    doc.save('comparison_report.pdf');
    document.getElementById('saveMsg').textContent = "âœ… PDF has been saved!";
});

function createTable(selectedCols, rows) {
    let html = "<table><tr><th>Metric</th><th>Pre</th><th>Post</th><th>Follow-up</th><th>% Change</th></tr>";
    selectedCols.forEach(col => {
        let pre = parseFloat(rows[0][col]) || "-";
        let post = parseFloat(rows[1][col]) || "-";
        let follow = parseFloat(rows[2][col]) || "-";
        let pctChange = (!isNaN(pre) && !isNaN(post) && pre !== 0) ? (((post - pre) / pre) * 100).toFixed(2) + "%" : "-";
        let colorClass = parseFloat(pctChange) > 0 ? 'class="green"' : (parseFloat(pctChange) < 0 ? 'class="red"' : '');
        html += `<tr><td>${allMetrics[col].name}</td><td>${pre}</td><td>${post}</td><td>${follow}</td><td ${colorClass}>${pctChange}</td></tr>`;
    });
    html += "</table>";
    return html;
}

function avg(arr) {
    const valid = arr.filter(x => !isNaN(x));
    return valid.length ? valid.reduce((a,b) => a+b,0)/valid.length : NaN;
}
</script>
</body>
</html>
